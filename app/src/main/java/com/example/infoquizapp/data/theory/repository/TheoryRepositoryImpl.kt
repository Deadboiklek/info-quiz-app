package com.example.infoquizapp.data.theory.repository

import android.text.Html
import com.example.infoquizapp.data.TheoryDao
import com.example.infoquizapp.data.theory.TheoryEntity
import com.example.infoquizapp.domain.theory.repository.TheoryRepository
import kotlinx.coroutines.CoroutineScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch

class TheoryRepositoryImpl(private val theoryDao: TheoryDao) : TheoryRepository {
    override suspend fun getTheory(id: Int): TheoryEntity? {
        return theoryDao.getTheoryById(id)
    }

    override suspend fun markTheoryAsRead(id: Int) {
        theoryDao.updateReadStatus(id, true)
    }

    override suspend fun getAllTheory(): List<TheoryEntity> {
        return theoryDao.getAllTheory()
    }

    init {
        CoroutineScope(Dispatchers.IO).launch {
            if (theoryDao.getTheoryCount() == 0) {
                val initialData = listOf(
                    TheoryEntity(
                        title = "Задание 1",
                        content = """
    **1. Основные понятия**
    
    1. Бит — минимальная единица информации (0 или 1).
    2. Байт = 8 бит.
    3. **Кодировка символов** — способ представления текста в компьютере:
       - **8-битная** (1 байт на символ) → ASCII, КОИ-8 (латиница, кириллица, цифры).
       - **16-битная** (2 байта на символ) → Unicode (UTF-16, поддерживает кириллицу, иероглифы).
       - **32-битная** (4 байта на символ) → UTF-32 (редко, для спецсимволов).
    4. **Формулы:**
       - Объём текста (в битах) = кол-во символов × бит на символ.
       - Перевод в байты: биты ÷ 8.
       - Перевод в КБ: байты ÷ 1024.

    **2. Типы задач и примеры решений**

    **1. Задачи на удаление слова из текста**
    
    **Алгоритм решения:**
    1. Определить, сколько байт занимает вычеркнутое слово.
    2. Учесть удаление лишних запятых и пробелов (обычно 2 символа).
    3. Составить уравнение на основе изменения размера текста.

    **Пример 1 (8-битная кодировка):**
    
    В кодировке КОИ-8 каждый символ кодируется 8 битами.  
    Текст: «Обь, Лена, Волга, Москва, Макензи, Амазонка — реки».  
    После удаления названия реки размер уменьшился на 8 байт. Какое слово вычеркнули?

    **Решение:**
    1. Размер уменьшился на 8 байт = 64 бита (1 байт = 8 бит).
    2. При удалении слова также удаляются 2 символа (запятая и пробел).
       - Их размер: 2 × 8 бит = 16 бит.
    3. Пусть длина вычеркнутого слова = L. Тогда:
       - L × 8 (бит) + 16 (бит) = 64 (бит)
       - L = (64-16)/8 = 6 символов
    4. Ищем слово из 6 букв: **Москва**.
    
    **Ответ:** Москва.

    **Пример 2 (16-битная кодировка):**
    
    В Unicode каждый символ кодируется 16 битами.  
    Текст: «Ель, кедр, сосна, кипарис, лиственница, можжевельник — хвойные растения».  
    После удаления слова размер уменьшился на 26 байт. Какое слово вычеркнули?

    **Решение:**
    1. Размер уменьшился на 26 байт = 208 бит.
    2. Удалено 2 символа: 2 × 16 бит = 32 бита.
    3. Уравнение:
       - L × 16 + 32 = 208
       - L = (208-32)/16 = 11 символов
    4. Ищем слово из 11 букв: **лиственница**.
    
    **Ответ:** лиственница.

    **Пример 3 (32-битная кодировка):**
    
    В UTF-32 каждый символ кодируется 32 битами.  
    Текст: «Айва, Алыча, Генипа, Гуарана, Курбарил, Мангостан — фрукты».  
    После удаления слова размер уменьшился на 36 байт. Какое слово вычеркнули?

    **Решение:**
    1. Размер уменьшился на 36 байт = 288 бит.
    2. Удалено 2 символа: 2 × 32 бит = 64 бита.
    3. Уравнение:
       - L × 32 + 64 = 288
       - L = (288-64)/32 = 7 символов
    4. Ищем слово из 7 букв: **Гуарана**.
    
    **Ответ:** Гуарана.

    **2. Задачи на расчёт объёма статьи**

    **Пример:**
    
    Статья содержит 30 страниц, на каждой 60 строк, в каждой строке 52 символа.  
    Символы кодируются в Unicode (2 байта на символ).  
    Определите объём статьи в КБ.

    **Решение:**
    1. Общее количество символов:
       - 30 стр. × 60 строк × 52 символа = 93600 символов
    2. Объём в байтах:
       - 93600 × 2 байта = 187200 байт
    3. Переводим в КБ:
       - 187200 ÷ 1024 = 182,8 КБ
    4. Округляем до целых, так как в ОГЭ обычно требуется точный ответ.

    **Ответ:** 183 КБ.

    **Важно:**
    - Внимательно читайте условие (может быть указано "без лишних пробелов").
    - Проверяйте единицы измерения (биты, байты, КБ).
""".trimIndent(),
                        isRead = false
                    )
                )
                theoryDao.insertAllTheory(initialData)
            }
        }
    }
}